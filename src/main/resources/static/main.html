<!DOCTYPE html>
<html lang="ko">
    <head>
        <meta charset="UTF-8" />
        <title>메인 - HS Code Radar</title>
        <style>
            body {
                font-family: sans-serif;
                padding: 40px;
                max-width: 800px;
                margin: auto;
            }
            .token-box {
                padding: 20px;
                background-color: #e9ecef;
                border: 1px solid #dee2e6;
                border-radius: 5px;
                word-wrap: break-word;
                margin-bottom: 20px;
            }
            h1,
            h2 {
                border-bottom: 2px solid #ccc;
                padding-bottom: 10px;
            }
            button {
                padding: 10px 15px;
                border: none;
                background-color: #dc3545;
                color: white;
                border-radius: 5px;
                cursor: pointer;
            }
            button:hover {
                background-color: #c82333;
            }
        </style>
    </head>
    <body>
        <h1>로그인 성공!</h1>
        <p>HS Code Radar에 오신 것을 환영합니다.</p>

        <h2>발급된 토큰 정보</h2>
        <p>OAuth2 또는 자체 로그인 성공 후, 백엔드에서 발급한 토큰입니다.</p>

        <h3>Access Token:</h3>
        <div id="accessToken" class="token-box">토큰 없음</div>

        <h3>Refresh Token:</h3>
        <div id="refreshToken" class="token-box">토큰 없음</div>

        <hr />

        <h2>로그아웃 테스트</h2>
        <p>아래 버튼을 클릭하여 로그아웃을 테스트합니다. 로그아웃 요청 시 Access Token이 필요합니다.</p>
        <button id="logoutButton">로그아웃 하기</button>
        <div id="logoutMessage" style="margin-top: 15px; font-weight: bold"></div>

        <script>
            // 다른 함수에서도 토큰을 사용할 수 있도록 전역 스코프에 변수를 선언합니다.
            let currentAccessToken = null;

            // 페이지가 로드될 때 URL의 쿼리 파라미터를 파싱하여 토큰 정보를 화면에 표시합니다.
            window.onload = function () {
                const urlParams = new URLSearchParams(window.location.search);
                const accessToken = urlParams.get("accessToken");
                const refreshToken = urlParams.get("refreshToken");

                if (accessToken) {
                    document.getElementById("accessToken").textContent = accessToken;
                    currentAccessToken = accessToken; // 전역 변수에 액세스 토큰을 저장합니다.
                }
                if (refreshToken) {
                    document.getElementById("refreshToken").textContent = refreshToken;
                }
            };

            // 로그아웃 버튼에 클릭 이벤트 리스너를 추가합니다.
            document.getElementById("logoutButton").addEventListener("click", async function () {
                const logoutMessageDiv = document.getElementById("logoutMessage");

                if (!currentAccessToken) {
                    logoutMessageDiv.style.color = "red";
                    logoutMessageDiv.textContent = "오류: 로그아웃에 사용할 액세스 토큰이 없습니다.";
                    return;
                }

                try {
                    // fetch API를 사용하여 서버에 POST 요청을 보냅니다.
                    const response = await fetch("/api/auth/logout", {
                        method: "POST",
                        headers: {
                            // 로그아웃 API는 인증이 필요하므로, Authorization 헤더에 Bearer 토큰을 추가해야 합니다.
                            Authorization: "Bearer " + currentAccessToken,
                        },
                    });

                    // 서버로부터 받은 응답을 JSON으로 파싱합니다.
                    const result = await response.json();

                    if (response.ok) {
                        logoutMessageDiv.style.color = "green";
                        logoutMessageDiv.textContent = `[성공] ${result.message}. 2초 후 로그인 페이지로 이동합니다.`;

                        // 성공 시 2초 후 로그인 페이지로 리디렉션
                        setTimeout(() => {
                            window.location.href = "/api/login-page";
                        }, 2000);
                    } else {
                        // 실패 시 (예: 토큰 만료 등)
                        logoutMessageDiv.style.color = "red";
                        logoutMessageDiv.textContent = `[오류] ${result.message}`;
                    }
                } catch (error) {
                    // 네트워크 오류 등
                    logoutMessageDiv.style.color = "red";
                    logoutMessageDiv.textContent = "요청 처리 중 오류가 발생했습니다: " + error.message;
                }
            });
        </script>
    </body>
</html>
